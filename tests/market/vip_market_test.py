from datetime import datetime
import requests
import pytest
from pytest_mock import mocker
from pandas import DataFrame
from src.valid_pairs import *
from src.market import BitcoinIndonesiaMarket

@pytest.fixture()
def market():
    return BitcoinIndonesiaMarket()

@pytest.fixture()
def req_mock(mocker, monkeypatch):
    mockery = mocker.Mock(return_value=mocker.Mock())
    mockery.return_value.content = '{"s":"mock","t":[],"o":"mock","h":"mock","l":"mock","c":"mock","v":"mock"}'
    monkeypatch.setattr(requests, 'get', mockery)
    return mockery

def test_get_ohlc_with_before_url(market, req_mock):
    symbol = BTCIDR
    before = 2
    after = 1
    expected_query = {'symbol': BitcoinIndonesiaMarket.PAIRS[symbol], 'from': str(after), 'to': str(before), 'resolution':'1'}
    market.get_ohlc(symbol, after, before=before)
    req_mock.assert_called_once_with('https://vip.bitcoin.co.id/tradingview/history', params=expected_query)

def test_get_ohlc_without_before_url(market, req_mock):
    symbol = BTCIDR
    before = int(datetime.now().timestamp())
    after = 1
    expected_query = {'symbol': BitcoinIndonesiaMarket.PAIRS[symbol], 'from': str(after), 'to': str(before), 'resolution':'1'}
    market.get_ohlc(symbol, after)
    req_mock.assert_called_once_with('https://vip.bitcoin.co.id/tradingview/history', params=expected_query)

def test_get_ohlc_invalid_currency(market, req_mock):
    symbol = 'USDIDR'
    after = 1
    with pytest.raises(RuntimeError) as excinfo:
        market.get_ohlc(symbol, 1)
    assert 'Invalid currency pair: ' + symbol in str(excinfo.value)

def test_parse_ohlc_data(market):
    json_str = '{\
        "s":"ok",\
        "t":[1514861100,1514862000,1514862900,1514863800,1514864700,1514865600,1514866500,1514867400,1514868300,1514869200],\
        "c":[217998000,216999000,215845000,215999000,215337000,216541000,215985000,214964000,214850000,215105000],\
        "o":[217084000,217998000,216999000,215845000,215999000,215337000,216541000,215985000,214964000,214850000],\
        "h":[217998000,218400000,217000000,215999000,216392000,217500000,217397000,215985000,214980000,215184000],\
        "l":[217006000,216900000,215000000,215251000,214017000,215000000,215100000,214151000,214202000,214849000],\
        "v":[3.18698879,6.82663246,15.68406076,2.15531776,12.87793266,7.0219555,4.56684082,7.37273228,8.14764141,3.09377636]\
    }'
    price = market.parse_ohlc_data(json_str)
    assert list(price.index) == [1514861100, 1514862000, 1514862900, 1514863800, 1514864700, 1514865600, 1514866500, 1514867400, 1514868300, 1514869200]
    assert list(price.open) == [217084000, 217998000, 216999000, 215845000, 215999000, 215337000, 216541000, 215985000, 214964000, 214850000]
    assert list(price.high) == [217998000, 218400000, 217000000, 215999000, 216392000, 217500000, 217397000, 215985000, 214980000, 215184000]
    assert list(price.low) == [217006000, 216900000, 215000000, 215251000, 214017000, 215000000, 215100000, 214151000, 214202000, 214849000] 
    assert list(price.close) == [217998000, 216999000, 215845000, 215999000, 215337000, 216541000, 215985000, 214964000, 214850000, 215105000]
    assert list(price.volume) == [3.18698879, 6.82663246, 15.68406076, 2.15531776, 12.87793266, 7.0219555, 4.56684082, 7.37273228, 8.14764141, 3.09377636]

def test_get_buy_order_book(market, req_mock):
    req_mock.return_value.content = '{"buy":[[18853000,"0.15371150"],[18851000,"0.03984096"],[18850000,"0.17848291"],[18802000,"0.01250196"],[18801000,"0.05318866"],[18800000,"3.25905595"],[18778000,"0.01966609"],[18724000,"4.87102424"],[18718000,"0.39542424"],[18702000,"0.00868762"],[18700000,"1.64035101"],[18698000,"0.08022248"],[18684000,"0.02676086"],[18683000,"0.02450516"],[18682000,"15.80000000"],[18681000,"0.04655425"],[18650000,"0.02680965"],[18649000,"0.33554775"],[18611000,"0.78619719"],[18610000,"2.04191295"],[18608000,"0.82924677"],[18606000,"157.35374610"],[18600000,"0.37172897"],[18599000,"0.18216194"],[18575000,"0.05383580"],[18562000,"0.01258409"],[18560000,"0.02693965"],[18558000,"9.24539298"],[18551000,"0.01078108"],[18550000,"3.54418382"],[18537000,"0.14101526"],[18527000,"0.16518189"],[18510000,"0.02160994"],[18502000,"0.31682688"],[18501000,"0.06486135"],[18500000,"5.73903562"],[18499000,"0.27937320"],[18478000,"0.11969823"],[18471000,"0.25544762"],[18449000,"0.38764035"],[18410000,"0.01086366"],[18405000,"0.01901657"],[18404000,"0.06520321"],[18403000,"0.05433896"],[18402000,"0.45245734"],[18400000,"3.02810396"],[18361000,"0.11488546"],[18338000,"0.02726578"],[18333000,"0.18639502"],[18326000,"0.02907895"],[18324000,"0.00545732"],[18323000,"0.02724924"],[18321000,"0.05458217"],[18310000,"0.05461496"],[18307000,"0.02463112"],[18305000,"12.71608877"],[18300000,"2.00142420"],[18299000,"0.01397830"],[18295000,"0.01309702"],[18280000,"2.83853183"],[18268000,"0.06654209"],[18251000,"0.44994279"],[18250000,"0.69844553"],[18248000,"0.44089894"],[18230000,"0.02558321"],[18216000,"0.00586012"],[18212000,"0.06973424"],[18202000,"0.01648170"],[18200000,"3.31165521"],[18199000,"0.16248788"],[18188000,"1.12187645"],[18170000,"0.27517886"],[18160000,"66.07929515"],[18159000,"0.08130089"],[18152000,"0.39441455"],[18151000,"0.13264007"],[18150000,"0.56239862"],[18147000,"0.01102110"],[18144000,"0.09638673"],[18108000,"0.02801452"],[18101000,"0.55245566"],[18100000,"1.18629403"],[18095000,"0.05526388"],[18088000,"1.38213180"],[18075000,"0.03205311"],[18062000,"0.05536485"],[18048000,"0.49531643"],[18018000,"0.01000000"],[18012000,"0.05551854"],[18010000,"0.11104941"],[18008000,"0.01237327"],[18005000,"0.03080088"],[18003000,"0.00555462"],[18001000,"0.19443364"],[18000000,"26.15183333"],[17999000,"0.27854141"],[17960000,"0.10440089"],[17959000,"0.05568238"],[17953000,"0.71025700"],[17950000,"0.59067582"],[17913000,"0.11165075"],[17909000,"0.03147311"],[17900000,"0.06424581"],[17850000,"0.07226890"],[17828000,"0.05784440"],[17820000,"0.01122334"],[17813000,"0.11227755"],[17807000,"0.16847307"],[17800000,"0.10005129"],[17799000,"0.05618293"],[17798000,"0.56186088"],[17774000,"0.20000000"],[17754000,"0.05632533"],[17750000,"1.70834461"],[17740000,"0.02113866"],[17719000,"0.11887995"],[17717000,"0.16932889"],[17713000,"0.11291142"],[17705000,"0.05648121"],[17700000,"0.17302259"],[17699000,"0.05102661"],[17657000,"0.02831738"],[17654000,"0.02135719"],[17650000,"3.27803824"],[17613000,"0.11355248"],[17600000,"0.28409090"],[17599000,"0.00284107"],[17570000,"0.03414968"],[17555000,"0.01139276"],[17553000,"0.01709109"],[17532000,"0.02283350"],[17513000,"0.11420087"],[17510000,"0.02999046"],[17505000,"0.05902890"],[17501000,"10.33972670"],[17500000,"3.87785737"],[17450000,"0.05503650"],[17424000,"0.01147842"],[17413000,"0.11485671"],[17400000,"0.01484419"],[17350000,"0.01440922"],[17313000,"0.11552012"],[17300000,"0.05780346"],[17299000,"0.13006532"],[17253000,"0.01738828"],[17250000,"0.00891426"],[17213000,"0.11619125"],[17200000,"0.12790697"],[17166000,"0.23301875"],[17121000,"0.11681560"]],"sell":[[18898000,"0.01157459"],[18899000,"4.50098492"],[18900000,"0.31818765"],[18906000,"0.66113731"],[18907000,"0.13154571"],[18979000,"15.70000000"],[19000000,"1.25445008"],[19100000,"0.05049293"],[19155000,"9.03914128"],[19173000,"157.20000000"],[19205000,"0.36279273"],[19210000,"0.03051297"],[19270000,"0.53591008"],[19290000,"0.05129825"],[19294000,"0.02879900"],[19296000,"0.04706534"],[19297000,"0.48479566"],[19298000,"0.10404844"],[19300000,"2.16518405"],[19336000,"0.41769567"],[19398000,"0.05131953"],[19400000,"0.54344875"],[19416000,"0.39259558"],[19431000,"0.02132037"],[19456000,"0.07976072"],[19495000,"64.50000000"],[19500000,"2.68438805"],[19502000,"0.32902415"],[19504000,"0.08237701"],[19516000,"0.10057434"],[19523000,"0.01265415"],[19540000,"0.18574165"],[19580000,"0.05003433"],[19600000,"2.32908989"],[19640000,"0.01808019"],[19646000,"0.10000000"],[19667000,"0.05010768"],[19700000,"0.05213042"],[19715000,"0.28119708"],[19743000,"0.13787009"],[19790000,"0.05263157"],[19796000,"0.10048494"],[19800000,"0.11746224"],[19848000,"0.51695616"],[19849000,"0.01490823"],[19850000,"1.83613216"],[19851000,"0.89799799"],[19872000,"0.11000000"],[19876000,"0.01173500"],[19879000,"0.33553227"],[19880000,"2.59918090"],[19890000,"0.47602461"],[19897000,"2.55000000"],[19899000,"0.18427635"],[19900000,"2.18225182"],[19901000,"0.01303044"],[19902000,"0.26253751"],[19903000,"0.03184070"],[19905000,"0.06719900"],[19924000,"0.20450392"],[19945000,"0.38671872"],[19947000,"0.09097550"],[19950000,"0.02141400"],[19951000,"0.05405405"],[19958000,"0.06900412"],[19977000,"0.01317008"],[19992000,"0.78766653"],[19997000,"0.02720477"],[19998000,"0.04376623"],[19999000,"2.22509224"],[20000000,"12.01979485"],[20001000,"0.01442670"],[20010000,"0.02736751"],[20011000,"0.57589323"],[20019000,"0.05225679"],[20037000,"0.01097935"],[20049000,"2.56210000"],[20050000,"0.94853866"],[20058000,"0.01180235"],[20089000,"0.82074578"],[20094000,"0.01000696"],[20099000,"0.20000000"],[20100000,"5.09448347"],[20105000,"0.05007635"],[20108000,"0.04813559"],[20111000,"0.14382494"],[20125000,"0.04755543"],[20130000,"0.01296173"],[20150000,"0.14431676"],[20156000,"0.25005255"],[20168000,"0.09548481"],[20180000,"2.99000000"],[20185000,"0.23745086"],[20196000,"0.01249063"],[20199000,"0.20000000"],[20200000,"0.75835528"],[20201000,"6.16664220"],[20203000,"0.02283532"],[20210000,"0.65194300"],[20250000,"1.73127444"],[20254000,"0.03101615"],[20261000,"0.05395605"],[20270000,"0.01140432"],[20286000,"0.02639481"],[20289000,"0.26762727"],[20299000,"0.22655479"],[20300000,"3.23526146"],[20301000,"0.09217087"],[20337000,"0.58917714"],[20341000,"1.28106274"],[20345000,"0.05003210"],[20350000,"1.01002023"],[20360000,"0.09977549"],[20371000,"0.04930517"],[20388000,"0.50701193"],[20400000,"1.93489369"],[20406000,"0.07022476"],[20412000,"0.05622558"],[20414000,"0.25018354"],[20418000,"0.02198056"],[20438000,"1.57353438"],[20441000,"1.00000000"],[20450000,"0.46705391"],[20453000,"0.05003733"],[20473000,"0.01074575"],[20492000,"0.10000000"],[20495000,"0.02278079"],[20499000,"3.04795342"],[20500000,"32.32824668"],[20502000,"0.19839519"],[20508000,"0.44083337"],[20511000,"0.15000017"],[20512000,"0.05025015"],[20513000,"0.02498376"],[20515000,"0.01668513"],[20532000,"0.19201700"],[20540000,"0.22727960"],[20541000,"1.00000000"],[20550000,"0.44934491"],[20565000,"2.65300000"],[20568000,"5.00000000"],[20588000,"0.02578898"],[20599000,"0.30000000"],[20600000,"10.43480286"],[20606000,"0.06630111"],[20615000,"0.02321350"],[20641000,"0.97898908"],[20648000,"0.01358460"],[20650000,"1.78839367"],[20666000,"0.11387052"]]}'
    depth = market.get_buy_order_book(ETHIDR)
    # sampling
    assert depth.buy[18853000] == 0.15371150
    assert depth.buy[18681000] == 0.04655425
    req_mock.assert_called_once_with('https://vip.bitcoin.co.id/api/eth_idr/depth')

def test_get_sell_order_book(market, req_mock):
    req_mock.return_value.content = '{"buy":[[18853000,"0.15371150"],[18851000,"0.03984096"],[18850000,"0.17848291"],[18802000,"0.01250196"],[18801000,"0.05318866"],[18800000,"3.25905595"],[18778000,"0.01966609"],[18724000,"4.87102424"],[18718000,"0.39542424"],[18702000,"0.00868762"],[18700000,"1.64035101"],[18698000,"0.08022248"],[18684000,"0.02676086"],[18683000,"0.02450516"],[18682000,"15.80000000"],[18681000,"0.04655425"],[18650000,"0.02680965"],[18649000,"0.33554775"],[18611000,"0.78619719"],[18610000,"2.04191295"],[18608000,"0.82924677"],[18606000,"157.35374610"],[18600000,"0.37172897"],[18599000,"0.18216194"],[18575000,"0.05383580"],[18562000,"0.01258409"],[18560000,"0.02693965"],[18558000,"9.24539298"],[18551000,"0.01078108"],[18550000,"3.54418382"],[18537000,"0.14101526"],[18527000,"0.16518189"],[18510000,"0.02160994"],[18502000,"0.31682688"],[18501000,"0.06486135"],[18500000,"5.73903562"],[18499000,"0.27937320"],[18478000,"0.11969823"],[18471000,"0.25544762"],[18449000,"0.38764035"],[18410000,"0.01086366"],[18405000,"0.01901657"],[18404000,"0.06520321"],[18403000,"0.05433896"],[18402000,"0.45245734"],[18400000,"3.02810396"],[18361000,"0.11488546"],[18338000,"0.02726578"],[18333000,"0.18639502"],[18326000,"0.02907895"],[18324000,"0.00545732"],[18323000,"0.02724924"],[18321000,"0.05458217"],[18310000,"0.05461496"],[18307000,"0.02463112"],[18305000,"12.71608877"],[18300000,"2.00142420"],[18299000,"0.01397830"],[18295000,"0.01309702"],[18280000,"2.83853183"],[18268000,"0.06654209"],[18251000,"0.44994279"],[18250000,"0.69844553"],[18248000,"0.44089894"],[18230000,"0.02558321"],[18216000,"0.00586012"],[18212000,"0.06973424"],[18202000,"0.01648170"],[18200000,"3.31165521"],[18199000,"0.16248788"],[18188000,"1.12187645"],[18170000,"0.27517886"],[18160000,"66.07929515"],[18159000,"0.08130089"],[18152000,"0.39441455"],[18151000,"0.13264007"],[18150000,"0.56239862"],[18147000,"0.01102110"],[18144000,"0.09638673"],[18108000,"0.02801452"],[18101000,"0.55245566"],[18100000,"1.18629403"],[18095000,"0.05526388"],[18088000,"1.38213180"],[18075000,"0.03205311"],[18062000,"0.05536485"],[18048000,"0.49531643"],[18018000,"0.01000000"],[18012000,"0.05551854"],[18010000,"0.11104941"],[18008000,"0.01237327"],[18005000,"0.03080088"],[18003000,"0.00555462"],[18001000,"0.19443364"],[18000000,"26.15183333"],[17999000,"0.27854141"],[17960000,"0.10440089"],[17959000,"0.05568238"],[17953000,"0.71025700"],[17950000,"0.59067582"],[17913000,"0.11165075"],[17909000,"0.03147311"],[17900000,"0.06424581"],[17850000,"0.07226890"],[17828000,"0.05784440"],[17820000,"0.01122334"],[17813000,"0.11227755"],[17807000,"0.16847307"],[17800000,"0.10005129"],[17799000,"0.05618293"],[17798000,"0.56186088"],[17774000,"0.20000000"],[17754000,"0.05632533"],[17750000,"1.70834461"],[17740000,"0.02113866"],[17719000,"0.11887995"],[17717000,"0.16932889"],[17713000,"0.11291142"],[17705000,"0.05648121"],[17700000,"0.17302259"],[17699000,"0.05102661"],[17657000,"0.02831738"],[17654000,"0.02135719"],[17650000,"3.27803824"],[17613000,"0.11355248"],[17600000,"0.28409090"],[17599000,"0.00284107"],[17570000,"0.03414968"],[17555000,"0.01139276"],[17553000,"0.01709109"],[17532000,"0.02283350"],[17513000,"0.11420087"],[17510000,"0.02999046"],[17505000,"0.05902890"],[17501000,"10.33972670"],[17500000,"3.87785737"],[17450000,"0.05503650"],[17424000,"0.01147842"],[17413000,"0.11485671"],[17400000,"0.01484419"],[17350000,"0.01440922"],[17313000,"0.11552012"],[17300000,"0.05780346"],[17299000,"0.13006532"],[17253000,"0.01738828"],[17250000,"0.00891426"],[17213000,"0.11619125"],[17200000,"0.12790697"],[17166000,"0.23301875"],[17121000,"0.11681560"]],"sell":[[18898000,"0.01157459"],[18899000,"4.50098492"],[18900000,"0.31818765"],[18906000,"0.66113731"],[18907000,"0.13154571"],[18979000,"15.70000000"],[19000000,"1.25445008"],[19100000,"0.05049293"],[19155000,"9.03914128"],[19173000,"157.20000000"],[19205000,"0.36279273"],[19210000,"0.03051297"],[19270000,"0.53591008"],[19290000,"0.05129825"],[19294000,"0.02879900"],[19296000,"0.04706534"],[19297000,"0.48479566"],[19298000,"0.10404844"],[19300000,"2.16518405"],[19336000,"0.41769567"],[19398000,"0.05131953"],[19400000,"0.54344875"],[19416000,"0.39259558"],[19431000,"0.02132037"],[19456000,"0.07976072"],[19495000,"64.50000000"],[19500000,"2.68438805"],[19502000,"0.32902415"],[19504000,"0.08237701"],[19516000,"0.10057434"],[19523000,"0.01265415"],[19540000,"0.18574165"],[19580000,"0.05003433"],[19600000,"2.32908989"],[19640000,"0.01808019"],[19646000,"0.10000000"],[19667000,"0.05010768"],[19700000,"0.05213042"],[19715000,"0.28119708"],[19743000,"0.13787009"],[19790000,"0.05263157"],[19796000,"0.10048494"],[19800000,"0.11746224"],[19848000,"0.51695616"],[19849000,"0.01490823"],[19850000,"1.83613216"],[19851000,"0.89799799"],[19872000,"0.11000000"],[19876000,"0.01173500"],[19879000,"0.33553227"],[19880000,"2.59918090"],[19890000,"0.47602461"],[19897000,"2.55000000"],[19899000,"0.18427635"],[19900000,"2.18225182"],[19901000,"0.01303044"],[19902000,"0.26253751"],[19903000,"0.03184070"],[19905000,"0.06719900"],[19924000,"0.20450392"],[19945000,"0.38671872"],[19947000,"0.09097550"],[19950000,"0.02141400"],[19951000,"0.05405405"],[19958000,"0.06900412"],[19977000,"0.01317008"],[19992000,"0.78766653"],[19997000,"0.02720477"],[19998000,"0.04376623"],[19999000,"2.22509224"],[20000000,"12.01979485"],[20001000,"0.01442670"],[20010000,"0.02736751"],[20011000,"0.57589323"],[20019000,"0.05225679"],[20037000,"0.01097935"],[20049000,"2.56210000"],[20050000,"0.94853866"],[20058000,"0.01180235"],[20089000,"0.82074578"],[20094000,"0.01000696"],[20099000,"0.20000000"],[20100000,"5.09448347"],[20105000,"0.05007635"],[20108000,"0.04813559"],[20111000,"0.14382494"],[20125000,"0.04755543"],[20130000,"0.01296173"],[20150000,"0.14431676"],[20156000,"0.25005255"],[20168000,"0.09548481"],[20180000,"2.99000000"],[20185000,"0.23745086"],[20196000,"0.01249063"],[20199000,"0.20000000"],[20200000,"0.75835528"],[20201000,"6.16664220"],[20203000,"0.02283532"],[20210000,"0.65194300"],[20250000,"1.73127444"],[20254000,"0.03101615"],[20261000,"0.05395605"],[20270000,"0.01140432"],[20286000,"0.02639481"],[20289000,"0.26762727"],[20299000,"0.22655479"],[20300000,"3.23526146"],[20301000,"0.09217087"],[20337000,"0.58917714"],[20341000,"1.28106274"],[20345000,"0.05003210"],[20350000,"1.01002023"],[20360000,"0.09977549"],[20371000,"0.04930517"],[20388000,"0.50701193"],[20400000,"1.93489369"],[20406000,"0.07022476"],[20412000,"0.05622558"],[20414000,"0.25018354"],[20418000,"0.02198056"],[20438000,"1.57353438"],[20441000,"1.00000000"],[20450000,"0.46705391"],[20453000,"0.05003733"],[20473000,"0.01074575"],[20492000,"0.10000000"],[20495000,"0.02278079"],[20499000,"3.04795342"],[20500000,"32.32824668"],[20502000,"0.19839519"],[20508000,"0.44083337"],[20511000,"0.15000017"],[20512000,"0.05025015"],[20513000,"0.02498376"],[20515000,"0.01668513"],[20532000,"0.19201700"],[20540000,"0.22727960"],[20541000,"1.00000000"],[20550000,"0.44934491"],[20565000,"2.65300000"],[20568000,"5.00000000"],[20588000,"0.02578898"],[20599000,"0.30000000"],[20600000,"10.43480286"],[20606000,"0.06630111"],[20615000,"0.02321350"],[20641000,"0.97898908"],[20648000,"0.01358460"],[20650000,"1.78839367"],[20666000,"0.11387052"]]}'
    depth = market.get_sell_order_book(XLMIDR)
    # sampling
    assert depth.sell[20512000] == 0.05025015
    assert depth.sell[19523000] == 0.01265415
    req_mock.assert_called_once_with('https://vip.bitcoin.co.id/api/str_idr/depth')

def test_get_best_price(market, req_mock):
    req_mock.return_value.content = '{"buy":[[18853000,"0.15371150"],[18851000,"0.03984096"],[18850000,"0.17848291"],[18802000,"0.01250196"],[18801000,"0.05318866"],[18800000,"3.25905595"],[18778000,"0.01966609"],[18724000,"4.87102424"],[18718000,"0.39542424"],[18702000,"0.00868762"],[18700000,"1.64035101"],[18698000,"0.08022248"],[18684000,"0.02676086"],[18683000,"0.02450516"],[18682000,"15.80000000"],[18681000,"0.04655425"],[18650000,"0.02680965"],[18649000,"0.33554775"],[18611000,"0.78619719"],[18610000,"2.04191295"],[18608000,"0.82924677"],[18606000,"157.35374610"],[18600000,"0.37172897"],[18599000,"0.18216194"],[18575000,"0.05383580"],[18562000,"0.01258409"],[18560000,"0.02693965"],[18558000,"9.24539298"],[18551000,"0.01078108"],[18550000,"3.54418382"],[18537000,"0.14101526"],[18527000,"0.16518189"],[18510000,"0.02160994"],[18502000,"0.31682688"],[18501000,"0.06486135"],[18500000,"5.73903562"],[18499000,"0.27937320"],[18478000,"0.11969823"],[18471000,"0.25544762"],[18449000,"0.38764035"],[18410000,"0.01086366"],[18405000,"0.01901657"],[18404000,"0.06520321"],[18403000,"0.05433896"],[18402000,"0.45245734"],[18400000,"3.02810396"],[18361000,"0.11488546"],[18338000,"0.02726578"],[18333000,"0.18639502"],[18326000,"0.02907895"],[18324000,"0.00545732"],[18323000,"0.02724924"],[18321000,"0.05458217"],[18310000,"0.05461496"],[18307000,"0.02463112"],[18305000,"12.71608877"],[18300000,"2.00142420"],[18299000,"0.01397830"],[18295000,"0.01309702"],[18280000,"2.83853183"],[18268000,"0.06654209"],[18251000,"0.44994279"],[18250000,"0.69844553"],[18248000,"0.44089894"],[18230000,"0.02558321"],[18216000,"0.00586012"],[18212000,"0.06973424"],[18202000,"0.01648170"],[18200000,"3.31165521"],[18199000,"0.16248788"],[18188000,"1.12187645"],[18170000,"0.27517886"],[18160000,"66.07929515"],[18159000,"0.08130089"],[18152000,"0.39441455"],[18151000,"0.13264007"],[18150000,"0.56239862"],[18147000,"0.01102110"],[18144000,"0.09638673"],[18108000,"0.02801452"],[18101000,"0.55245566"],[18100000,"1.18629403"],[18095000,"0.05526388"],[18088000,"1.38213180"],[18075000,"0.03205311"],[18062000,"0.05536485"],[18048000,"0.49531643"],[18018000,"0.01000000"],[18012000,"0.05551854"],[18010000,"0.11104941"],[18008000,"0.01237327"],[18005000,"0.03080088"],[18003000,"0.00555462"],[18001000,"0.19443364"],[18000000,"26.15183333"],[17999000,"0.27854141"],[17960000,"0.10440089"],[17959000,"0.05568238"],[17953000,"0.71025700"],[17950000,"0.59067582"],[17913000,"0.11165075"],[17909000,"0.03147311"],[17900000,"0.06424581"],[17850000,"0.07226890"],[17828000,"0.05784440"],[17820000,"0.01122334"],[17813000,"0.11227755"],[17807000,"0.16847307"],[17800000,"0.10005129"],[17799000,"0.05618293"],[17798000,"0.56186088"],[17774000,"0.20000000"],[17754000,"0.05632533"],[17750000,"1.70834461"],[17740000,"0.02113866"],[17719000,"0.11887995"],[17717000,"0.16932889"],[17713000,"0.11291142"],[17705000,"0.05648121"],[17700000,"0.17302259"],[17699000,"0.05102661"],[17657000,"0.02831738"],[17654000,"0.02135719"],[17650000,"3.27803824"],[17613000,"0.11355248"],[17600000,"0.28409090"],[17599000,"0.00284107"],[17570000,"0.03414968"],[17555000,"0.01139276"],[17553000,"0.01709109"],[17532000,"0.02283350"],[17513000,"0.11420087"],[17510000,"0.02999046"],[17505000,"0.05902890"],[17501000,"10.33972670"],[17500000,"3.87785737"],[17450000,"0.05503650"],[17424000,"0.01147842"],[17413000,"0.11485671"],[17400000,"0.01484419"],[17350000,"0.01440922"],[17313000,"0.11552012"],[17300000,"0.05780346"],[17299000,"0.13006532"],[17253000,"0.01738828"],[17250000,"0.00891426"],[17213000,"0.11619125"],[17200000,"0.12790697"],[17166000,"0.23301875"],[17121000,"0.11681560"]],"sell":[[18898000,"0.01157459"],[18899000,"4.50098492"],[18900000,"0.31818765"],[18906000,"0.66113731"],[18907000,"0.13154571"],[18979000,"15.70000000"],[19000000,"1.25445008"],[19100000,"0.05049293"],[19155000,"9.03914128"],[19173000,"157.20000000"],[19205000,"0.36279273"],[19210000,"0.03051297"],[19270000,"0.53591008"],[19290000,"0.05129825"],[19294000,"0.02879900"],[19296000,"0.04706534"],[19297000,"0.48479566"],[19298000,"0.10404844"],[19300000,"2.16518405"],[19336000,"0.41769567"],[19398000,"0.05131953"],[19400000,"0.54344875"],[19416000,"0.39259558"],[19431000,"0.02132037"],[19456000,"0.07976072"],[19495000,"64.50000000"],[19500000,"2.68438805"],[19502000,"0.32902415"],[19504000,"0.08237701"],[19516000,"0.10057434"],[19523000,"0.01265415"],[19540000,"0.18574165"],[19580000,"0.05003433"],[19600000,"2.32908989"],[19640000,"0.01808019"],[19646000,"0.10000000"],[19667000,"0.05010768"],[19700000,"0.05213042"],[19715000,"0.28119708"],[19743000,"0.13787009"],[19790000,"0.05263157"],[19796000,"0.10048494"],[19800000,"0.11746224"],[19848000,"0.51695616"],[19849000,"0.01490823"],[19850000,"1.83613216"],[19851000,"0.89799799"],[19872000,"0.11000000"],[19876000,"0.01173500"],[19879000,"0.33553227"],[19880000,"2.59918090"],[19890000,"0.47602461"],[19897000,"2.55000000"],[19899000,"0.18427635"],[19900000,"2.18225182"],[19901000,"0.01303044"],[19902000,"0.26253751"],[19903000,"0.03184070"],[19905000,"0.06719900"],[19924000,"0.20450392"],[19945000,"0.38671872"],[19947000,"0.09097550"],[19950000,"0.02141400"],[19951000,"0.05405405"],[19958000,"0.06900412"],[19977000,"0.01317008"],[19992000,"0.78766653"],[19997000,"0.02720477"],[19998000,"0.04376623"],[19999000,"2.22509224"],[20000000,"12.01979485"],[20001000,"0.01442670"],[20010000,"0.02736751"],[20011000,"0.57589323"],[20019000,"0.05225679"],[20037000,"0.01097935"],[20049000,"2.56210000"],[20050000,"0.94853866"],[20058000,"0.01180235"],[20089000,"0.82074578"],[20094000,"0.01000696"],[20099000,"0.20000000"],[20100000,"5.09448347"],[20105000,"0.05007635"],[20108000,"0.04813559"],[20111000,"0.14382494"],[20125000,"0.04755543"],[20130000,"0.01296173"],[20150000,"0.14431676"],[20156000,"0.25005255"],[20168000,"0.09548481"],[20180000,"2.99000000"],[20185000,"0.23745086"],[20196000,"0.01249063"],[20199000,"0.20000000"],[20200000,"0.75835528"],[20201000,"6.16664220"],[20203000,"0.02283532"],[20210000,"0.65194300"],[20250000,"1.73127444"],[20254000,"0.03101615"],[20261000,"0.05395605"],[20270000,"0.01140432"],[20286000,"0.02639481"],[20289000,"0.26762727"],[20299000,"0.22655479"],[20300000,"3.23526146"],[20301000,"0.09217087"],[20337000,"0.58917714"],[20341000,"1.28106274"],[20345000,"0.05003210"],[20350000,"1.01002023"],[20360000,"0.09977549"],[20371000,"0.04930517"],[20388000,"0.50701193"],[20400000,"1.93489369"],[20406000,"0.07022476"],[20412000,"0.05622558"],[20414000,"0.25018354"],[20418000,"0.02198056"],[20438000,"1.57353438"],[20441000,"1.00000000"],[20450000,"0.46705391"],[20453000,"0.05003733"],[20473000,"0.01074575"],[20492000,"0.10000000"],[20495000,"0.02278079"],[20499000,"3.04795342"],[20500000,"32.32824668"],[20502000,"0.19839519"],[20508000,"0.44083337"],[20511000,"0.15000017"],[20512000,"0.05025015"],[20513000,"0.02498376"],[20515000,"0.01668513"],[20532000,"0.19201700"],[20540000,"0.22727960"],[20541000,"1.00000000"],[20550000,"0.44934491"],[20565000,"2.65300000"],[20568000,"5.00000000"],[20588000,"0.02578898"],[20599000,"0.30000000"],[20600000,"10.43480286"],[20606000,"0.06630111"],[20615000,"0.02321350"],[20641000,"0.97898908"],[20648000,"0.01358460"],[20650000,"1.78839367"],[20666000,"0.11387052"]]}'
    assert market.get_best_price(ETHIDR) == 18875500

def test_get_buy_order_book_invalid_currency(market, req_mock):
    currency = 'USDIDR'
    with pytest.raises(RuntimeError) as excinfo:
        market.get_buy_order_book(currency)
    assert 'Invalid currency pair: ' + currency in str(excinfo.value)

def test_get_sell_order_book_invalid_currency(market, req_mock):
    currency = 'USDIDR'
    with pytest.raises(RuntimeError) as excinfo:
        market.get_sell_order_book(currency)
    assert 'Invalid currency pair: ' + currency in str(excinfo.value)
